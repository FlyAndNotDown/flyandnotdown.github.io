<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="我和 Explosion 游戏引擎那些事"><meta name=keywords content="explosion,c++,游戏引擎,渲染,图形"><title>Explosion 开发笔记 (四)</title><link rel=canonical href=https://flyandnotdown.github.io/post/44/><link rel=stylesheet href=/scss/style.min.css><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?a0c486208ba4751b6988ccc92f1479ee",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Explosion 开发笔记 (四)"><meta property="og:description" content="我和 Explosion 游戏引擎那些事"><meta property="og:url" content="https://flyandnotdown.github.io/post/44/"><meta property="og:site_name" content="Kindem的博客"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Explosion"><meta property="article:tag" content="Game"><meta property="article:tag" content="Graphics"><meta property="article:published_time" content="2021-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-20T00:00:00+00:00"><meta name=twitter:title content="Explosion 开发笔记 (四)"><meta name=twitter:description content="我和 Explosion 游戏引擎那些事"><link rel="shortcut icon" href=#ZgotmplZ><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3YCH8P4PP"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3YCH8P4PP",{anonymize_ip:!1})}</script></head><body><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.body.dataset.scheme="dark":document.body.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_hu0f5c0aa158a4e8466efa1fc48b48096f_378948_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🎯</span></figure><h1 class=site-name><a href=https://flyandnotdown.github.io/>Kindem的博客</a></h1><h2 class=site-description>层楼终究误少年，自由早晚乱余生</h2></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><li><a href=/friends/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>友链</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://flyandnotdown.github.io/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%8A%80%E6%9C%AF/>技术</a></header><h2 class=article-title><a href=/post/44/>Explosion 开发笔记 (四)</a></h2><h3 class=article-subtitle>我和 Explosion 游戏引擎那些事</h3><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Jul 20, 2021</time></footer></div></header><section class=article-content><p>前两个月在 Explosion 上下了不少功夫，好几周双休都抽出了一整天来开发引擎、做之后的设计，平日里下班了也是第一时间埋着头就开始写。直到这两周，Explosion 又暂停了下来，主要因为去杭州出差了，项目比较忙，没什么时间写。</p><p>今天下班比较早，想起来了该要写笔记了，就提笔记录记录。</p><h1 id=近期进展>近期进展</h1><h2 id=system--systemgroup--systemgraph>System / SystemGroup / SystemGraph</h2><p>ECS 框架我们是直接引用的 <a class=link href=https://github.com/skypjack/entt target=_blank rel=noopener>EnTT</a>，但 EnTT 只提供了 Entity、Component 的概念，没有直接提供 System，它的本意是只负责 ECS 框架中最困难的内存管理部分，所以 System 的概念需要自己封装。</p><p>在基础的 System 定义上，我们稍作了简化，并添加了 SystemGroup 和 SystemGraph 的概念，他们的定义如下：</p><ul><li>System：一个 Lambda 表达式，即代表一段可执行的逻辑。</li><li>SystemGroup：保存了一组 System 和一个 SystemGraph。</li><li>SystemGraph：描述了 SystemGroup 内部 System 之间的依赖关系。</li></ul><p>另外，他们遵循如下规则：</p><ul><li>World#Tick() 会更新所有 SystemGroup，SystemGroup 具有优先级，SystemGroup 之间会按照优先级<strong>串行</strong>更新。</li><li>SystemGroup 内部的所有 System 会按照 SystemGraph 编译成一个 TaskFlow，用于描述一个更新任务。</li><li>TaskFlow Execute 的时候有依赖关系的 System 会进行软同步，按照先后顺序执行，没有依赖关系的 System 会并行执行。</li><li>System 之间可以拥有共享内存，也使用 Component 实现，我们称之为 SharedComponent，SystemGraph 产生的依赖关系可以保证这块内存的同步访问。</li></ul><p>下面是部分定义以及 World#Tick() 的部分代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>using</span> <span class=n>System</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=n>Registry</span><span class=o>&amp;</span> <span class=n>registry</span><span class=p>,</span> <span class=kt>float</span> <span class=n>time</span><span class=p>)</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>SystemGroup</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>priority</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span> <span class=n>System</span><span class=o>&gt;</span> <span class=n>systems</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// SystemGraph 的简易实现，等完善的图模板库写出来之后替换掉
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span> <span class=n>dependencies</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>World</span><span class=o>::</span><span class=n>TickSystem</span><span class=p>(</span><span class=kt>float</span> <span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update system group on by one
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>systemGroup</span> <span class=p>:</span> <span class=n>systemGroups</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JobSystem</span><span class=o>::</span><span class=n>TaskFlow</span> <span class=n>taskFlow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>,</span> <span class=n>JobSystem</span><span class=o>::</span><span class=n>Task</span><span class=o>&gt;</span> <span class=n>tasks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>sysIter</span> <span class=p>:</span> <span class=n>systemGroup</span><span class=p>.</span><span class=n>systems</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>tasks</span><span class=p>[</span><span class=n>sysIter</span><span class=p>.</span><span class=n>first</span><span class=p>]</span> <span class=o>=</span> <span class=n>taskFlow</span><span class=p>.</span><span class=n>emplace</span><span class=p>([</span><span class=o>&amp;</span><span class=n>sysIter</span><span class=p>,</span> <span class=n>time</span><span class=p>,</span> <span class=k>this</span><span class=p>]()</span> <span class=o>-&gt;</span> <span class=kt>void</span> <span class=p>{</span> <span class=n>sysIter</span><span class=p>.</span><span class=n>second</span><span class=p>(</span><span class=n>registry</span><span class=p>,</span> <span class=n>time</span><span class=p>);</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>depIter</span> <span class=p>:</span> <span class=n>systemGroup</span><span class=p>.</span><span class=n>dependencies</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>tasks</span><span class=p>[</span><span class=n>depIter</span><span class=p>.</span><span class=n>first</span><span class=p>].</span><span class=n>succeed</span><span class=p>(</span><span class=n>tasks</span><span class=p>[</span><span class=n>depIter</span><span class=p>.</span><span class=n>second</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>JobSystem</span><span class=o>::</span><span class=n>Executor</span> <span class=n>executor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>executor</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=n>taskFlow</span><span class=p>).</span><span class=n>wait</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>下面是一小段 ECS 的 UT：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>TEST</span><span class=p>(</span><span class=n>WorldTest</span><span class=p>,</span> <span class=n>SystemDependenciesTest</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>SharedComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>transfer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>OutputComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>World</span> <span class=n>world</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>registry</span> <span class=o>=</span> <span class=n>world</span><span class=p>.</span><span class=n>GetRegistry</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Entity</span> <span class=n>entity1</span> <span class=o>=</span> <span class=n>registry</span><span class=p>.</span><span class=n>CreateEntity</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>AddComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity1</span><span class=p>,</span> <span class=mi>1u</span><span class=p>,</span> <span class=mi>0u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>AddComponent</span><span class=o>&lt;</span><span class=n>OutputComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity1</span><span class=p>,</span> <span class=mi>0u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Entity</span> <span class=n>entity2</span> <span class=o>=</span> <span class=n>registry</span><span class=p>.</span><span class=n>CreateEntity</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>AddComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity2</span><span class=p>,</span> <span class=mi>3u</span><span class=p>,</span> <span class=mi>0u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>registry</span><span class=p>.</span><span class=n>AddComponent</span><span class=o>&lt;</span><span class=n>OutputComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity2</span><span class=p>,</span> <span class=mi>0u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SystemGroup</span> <span class=n>systemGroup</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>systemGroup</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>&#34;group1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>systemGroup</span><span class=p>.</span><span class=n>priority</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>systemGroup</span><span class=p>.</span><span class=n>systems</span><span class=p>[</span><span class=s>&#34;middleSystem&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[](</span><span class=n>Registry</span><span class=o>&amp;</span> <span class=n>registry</span><span class=p>,</span> <span class=kt>float</span> <span class=n>time</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span> <span class=n>view</span> <span class=o>=</span> <span class=n>registry</span><span class=p>.</span><span class=n>CreateView</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=p>.</span><span class=n>Each</span><span class=p>([](</span><span class=n>SharedComponent</span><span class=o>&amp;</span> <span class=n>sharedComp</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>sharedComp</span><span class=p>.</span><span class=n>transfer</span> <span class=o>=</span> <span class=n>sharedComp</span><span class=p>.</span><span class=n>input</span> <span class=o>*</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>systemGroup</span><span class=p>.</span><span class=n>systems</span><span class=p>[</span><span class=s>&#34;outputSystem&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[](</span><span class=n>Registry</span><span class=o>&amp;</span> <span class=n>registry</span><span class=p>,</span> <span class=kt>float</span> <span class=n>time</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span> <span class=n>view</span> <span class=o>=</span> <span class=n>registry</span><span class=p>.</span><span class=n>CreateView</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=p>,</span> <span class=n>OutputComponent</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=p>.</span><span class=n>Each</span><span class=p>([](</span><span class=n>SharedComponent</span><span class=o>&amp;</span> <span class=n>sharedComp</span><span class=p>,</span> <span class=n>OutputComponent</span><span class=o>&amp;</span> <span class=n>outputComp</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>outputComp</span><span class=p>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>sharedComp</span><span class=p>.</span><span class=n>transfer</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>systemGroup</span><span class=p>.</span><span class=n>dependencies</span><span class=p>[</span><span class=s>&#34;outputSystem&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;middleSystem&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>world</span><span class=p>.</span><span class=n>AddSystemGroups</span><span class=p>(</span><span class=n>systemGroup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>world</span><span class=p>.</span><span class=n>Tick</span><span class=p>(</span><span class=mf>.16f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity1</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>input</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity1</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>transfer</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>OutputComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity1</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity2</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>input</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>SharedComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity2</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>transfer</span><span class=p>,</span> <span class=mi>12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ASSERT_EQ</span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=n>GetComponent</span><span class=o>&lt;</span><span class=n>OutputComponent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>entity2</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>,</span> <span class=mi>15</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>总体来说写起来还算可以，这么设计的初衷主要有两个：</p><ul><li>处理 System 依赖问题</li><li>处理 System 间传递数据问题</li></ul><p>大道至简，我不想把一套本来很简单的机制设计的过于复杂，从而增加维护的难度，之后等渲染管线搭起来之后再测一测性能，天然的多线程支持应该不会慢到哪里去。另外就是这样的写法会非常自由，对之后写引擎核心的 CPU 端逻辑会产生更高的要求，后面实际写起来的时候再看看效果吧。</p><h2 id=explosion-3rd-party-package>Explosion 3rd Party Package</h2><p>我本人其实是非常不想在 CI 上花太多时间的，但是 3rd Party Package 这个事情不搞又完全不行，因为越来越多的三方库直接源码引入，一是主仓体积逐渐增大，二是遇到一些巨大的库 （例如 <a class=link href=https://v8.dev/ target=_blank rel=noopener>V8</a>），光是构建就需要两小时，不可能本地编译的，这个事情会很大程度上影响大家的工作效率。</p><p>我们的解决方案是创建一个单独的仓库，即 <a class=link href=https://github.com/ExplosionEngine/Explosion3rdParty target=_blank rel=noopener>Explosion3rd</a>，它的任务如下：</p><ul><li>以 Git Sub-Module 的形式管理所有三方库源码，支持我们自己的侵入式修改。</li><li>支持一键构建所有三方库在各平台上（目前支持 MacOS、Visual Stdio 2019）的二进制包，并全自动打包成 Zip 发布到 <a class=link href=https://github.com/ExplosionEngine/Explosion3rdParty/releases target=_blank rel=noopener>Release</a> 页面，用户在编译 Explosion 本体前需要自行下载、解压这个包。</li><li>管理三方库的版本与依赖关系，将其归档到 Release 包的 CMakeLists.txt 中。</li></ul><p>这样一来，主仓就可以只管理 Explosion 的代码本身了。</p><p>Explosion3rd 的打包流程完全基于 <a class=link href=https://github.com/ExplosionEngine/Explosion3rdParty/actions target=_blank rel=noopener>GitHub Actions</a> 实现：</p><p><figure style=flex-grow:215;flex-basis:516px><a href=/post/44/1.png data-size=2768x1286><img src=/post/44/1.png srcset="/post/44/1_hu04341a90057bbd1585693d475edb07b5_298764_480x0_resize_box_3.png 480w, /post/44/1_hu04341a90057bbd1585693d475edb07b5_298764_1024x0_resize_box_3.png 1024w" width=2768 height=1286 loading=lazy alt=Actions></a><figcaption>Actions</figcaption></figure></p><p>每次更新之后，只需要手动输入版本号并 Dispatch 一下，Actions 就会全自动地构建二进制包，并发布到 Release 页面，下面是其中一个平台自动构建、打包的 CI 代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>release-windows</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>windows-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Update SubModules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          git submodule init
</span></span></span><span class=line><span class=cl><span class=sd>          git submodule update</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install 7-zip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          Invoke-WebRequest -Uri https://7-zip.org/a/7z1900-x64.msi -OutFile 7z.msi
</span></span></span><span class=line><span class=cl><span class=sd>          msiexec.exe /package 7z.msi /qn
</span></span></span><span class=line><span class=cl><span class=sd>          echo &#34;C:\Program Files\7-Zip&#34; | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Create Archive Directories</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/entt
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/entt/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glm
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glm/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/rapidjson
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/rapidjson/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/taskflow
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/taskflow/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glfw
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glfw/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glfw/Lib
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glfw/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glfw/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/gflags
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/gflags/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/gflags/Lib
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/gflags/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/gflags/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/assimp
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/assimp/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/assimp/Lib
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/assimp/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/assimp/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/googletest
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/googletest/Include
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/googletest/Lib
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/googletest/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glslang
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glslang/Lib
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glslang/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir Win/glslang/Lib/Release</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving CMakeLists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          </span><span class=l>cp CMakeLists.txt Win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving EnTT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          </span><span class=l>cp -r entt/single_include/entt Win/entt/Include</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving GLM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r glm/glm Win/glm/Include/glm
</span></span></span><span class=line><span class=cl><span class=sd>          rm Win/glm/Include/glm/CMakeLists.txt</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving rapidjson</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          </span><span class=l>cp -r rapidjson/include/rapidjson Win/rapidjson/Include/rapidjson</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving TaskFlow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          </span><span class=l>cp -r taskflow/taskflow Win/taskflow/Include/taskflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building GFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S gflags -B gflags/build-debug -DBUILD_SHARED_LIBS=OFF -DBUILD_STATIC_LIBS=ON -DBUILD_gflags_LIB=OFF -DBUILD_gflags_nothreads_LIB=ON -DBUILD_PACKAGING=OFF -DBUILD_TESTING=OFF -DINSTALL_HEADERS=ON -DINSTALL_SHARED_LIBS=OFF -DINSTALL_STATIC_LIBS=ON -DREGISTER_BUILD_DIR=OFF -DREGISTER_INSTALL_PREFIX=OFF -DCMAKE_INSTALL_PREFIX=gflags/build-debug/install
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build gflags/build-debug --config Debug -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --install gflags/build-debug --config Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S gflags -B gflags/build-release -DBUILD_SHARED_LIBS=OFF -DBUILD_STATIC_LIBS=ON -DBUILD_gflags_LIB=OFF -DBUILD_gflags_nothreads_LIB=ON -DBUILD_PACKAGING=OFF -DBUILD_TESTING=OFF -DINSTALL_HEADERS=ON -DINSTALL_SHARED_LIBS=OFF -DINSTALL_STATIC_LIBS=ON -DREGISTER_BUILD_DIR=OFF -DREGISTER_INSTALL_PREFIX=OFF -DCMAKE_INSTALL_PREFIX=gflags/build-release/install
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build gflags/build-release --config release -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --install gflags/build-release --config release</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving GFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r gflags/build-debug/install/include/* Win/gflags/Include
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r gflags/build-debug/install/lib/* Win/gflags/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r gflags/build-release/install/lib/* Win/gflags/Lib/Release</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building Assimp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S assimp -B assimp/build-debug -DBUILD_SHARED_LIBS=OFF -DASSIMP_BUILD_TESTS=OFF
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build assimp/build-debug --config Debug -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S assimp -B assimp/build-release -DBUILD_SHARED_LIBS=OFF -DASSIMP_BUILD_TESTS=OFF
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build assimp/build-release --config Release -j 8</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving Assimp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r assimp/include/* Win/assimp/Include
</span></span></span><span class=line><span class=cl><span class=sd>          cp assimp/build-debug/include/assimp/config.h Win/assimp/Include/assimp
</span></span></span><span class=line><span class=cl><span class=sd>          cp assimp/build-debug/lib/Debug/assimp-vc142-mtd.lib Win/assimp/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp assimp/build-debug/lib/Debug/assimp-vc142-mtd.pdb Win/assimp/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp assimp/build-release/lib/Release/assimp-vc142-mt.lib Win/assimp/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          </span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building GLFW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir glfw/build-debug
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S glfw -B glfw/build -DGLFW_BUILD_EXAMPLES=false -DGLFW_BUILD_TESTS=false -DGLFW_BUILD_DOCS=false -DUSE_MSVC_RUNTIME_LIBRARY_DLL=OFF
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build glfw/build --config Debug -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build glfw/build --config Release -j 8</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving GLFW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp glfw/build/src/Debug/glfw3.lib Win/glfw/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp glfw/build/src/Debug/glfw3.pdb Win/glfw/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp glfw/build/src/Release/glfw3.lib Win/glfw/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r glfw/include/GLFW Win/glfw/Include/GLFW</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building GoogleTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          mkdir googletest/build-debug
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S googletest -B googletest/build
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build googletest/build --config Debug -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build googletest/build --config Release -j 8</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving Google Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gtestd.lib Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gmockd.lib Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gtest_maind.lib Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gmock_maind.lib Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gtestd.pdb Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gmockd.pdb Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gtest_maind.pdb Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Debug/gmock_maind.pdb Win/googletest/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Release/gtest.lib Win/googletest/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Release/gmock.lib Win/googletest/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Release/gtest_main.lib Win/googletest/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp googletest/build/lib/Release/gmock_main.lib Win/googletest/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r googletest/googletest/include/gtest Win/googletest/Include/gtest
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r googletest/googlemock/include/gmock Win/googletest/Include/gmock</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building Glslang</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S glslang -B glslang/build-debug -DBUILD_TESTING=false -DENABLE_CTEST=false -DCMAKE_INSTALL_PREFIX=glslang/build-debug
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build glslang/build-debug --config Debug -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --install glslang/build-debug --config Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cmake -S glslang -B glslang/build-release -DBUILD_TESTING=false -DENABLE_CTEST=false -DCMAKE_INSTALL_PREFIX=glslang/build-release
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --build glslang/build-release --config Release -j 8
</span></span></span><span class=line><span class=cl><span class=sd>          cmake --install glslang/build-release --config Release</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Archiving Glslang</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r glslang/build-debug/lib Win/glslang/Lib/Debug
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r glslang/build-release/lib Win/glslang/Lib/Release
</span></span></span><span class=line><span class=cl><span class=sd>          cp -r glslang/build-debug/include Win/glslang/Include</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Zip Release Package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>7z a Win.zip Win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Create Release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>create_release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/create-release@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.event.inputs.version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>GITHUB_TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tag_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Win-${{ github.event.inputs.version }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>release_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Win-${{ github.event.inputs.version }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>draft</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>prerelease</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Upload Release Assets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/upload-release-asset@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.event.inputs.version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>GITHUB_TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>upload_url</span><span class=p>:</span><span class=w> </span><span class=l>${{ steps.create_release.outputs.upload_url }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>asset_path</span><span class=p>:</span><span class=w> </span><span class=l>Win.zip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>asset_name</span><span class=p>:</span><span class=w> </span><span class=l>Win.zip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>asset_content_type</span><span class=p>:</span><span class=w> </span><span class=l>application/zip</span><span class=w>
</span></span></span></code></pre></div><p>其实就是一堆 CMake 和 Make 指令，最后将所有需要的 Includes 和 Libs 归档到一个 Zip 中，然后调用 <code>actions/upload-release-asset@v1</code> 插件自动发布 Release。</p><p>可以看看打包的 Zip 的内容：</p><p><figure style=flex-grow:148;flex-basis:357px><a href=/post/44/2.png data-size=1840x1236><img src=/post/44/2.png srcset="/post/44/2_hud7d7a73b47fa28435918b8bcb5950e8f_394192_480x0_resize_box_3.png 480w, /post/44/2_hud7d7a73b47fa28435918b8bcb5950e8f_394192_1024x0_resize_box_3.png 1024w" width=1840 height=1236 loading=lazy alt=Contents></a><figcaption>Contents</figcaption></figure></p><p>主仓库那边的代码在 CMake 时需要添加一个 CMake 变量来指定这个包的路径，可以在命令行使用 <code>-DEXP_3RD_ROOT=xxx</code> 来传入，这样主库就会直接引入这边的三方库。</p><p>下面是 <code>Explosion3rd/CMakeLists.txt</code> 的内容以及相关定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// Explosion/cmake/Explosion.cmake
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>function</span><span class=p>(</span><span class=n>exp_external_library</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cmake_parse_arguments</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>PARAMS</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;NAME&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>ARGN</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>EXISTS</span> <span class=s>&#34;${EXP_3RD_ROOT}/${PARAMS_NAME}/Include&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>set</span><span class=p>(</span><span class=s>&#34;${PARAMS_NAME}_INCS&#34;</span> <span class=s>&#34;${EXP_3RD_ROOT}/${PARAMS_NAME}/Include&#34;</span> <span class=n>CACHE</span> <span class=n>STRING</span> <span class=s>&#34;include dirs of ${PARAMS_NAME} library&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>endif</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>EXISTS</span> <span class=s>&#34;${EXP_3RD_ROOT}/${PARAMS_NAME}/Lib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=err>$</span><span class=p>{</span><span class=n>WIN32</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=n>set</span><span class=p>(</span><span class=n>LIBS</span> <span class=s>&#34;${EXP_3RD_ROOT}/${PARAMS_NAME}/Lib/${CMAKE_BUILD_TYPE}/*.lib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>(</span><span class=err>$</span><span class=p>{</span><span class=n>APPLE</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=n>file</span><span class=p>(</span><span class=n>GLOB</span> <span class=n>LIBS</span> <span class=s>&#34;${EXP_3RD_ROOT}/${PARAMS_NAME}/Lib/${CMAKE_BUILD_TYPE}/*.a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>endif</span> <span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>set</span><span class=p>(</span><span class=s>&#34;${PARAMS_NAME}_LIBS&#34;</span> <span class=err>$</span><span class=p>{</span><span class=n>LIBS</span><span class=p>}</span> <span class=n>CACHE</span> <span class=n>STRING</span> <span class=s>&#34;include dirs of ${PARAMS_NAME} library&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>endif</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>endfunction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Explosion3rd/CMakeLists.txt
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>entt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>glfw</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>glm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>glslang</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>googletest</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>rapidjson</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>taskflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>assimp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp_external_library</span><span class=p>(</span><span class=n>NAME</span> <span class=n>gflags</span><span class=p>)</span>
</span></span></code></pre></div><p><code>exp_external_library</code> 会为每个库自动扫描 Includes 和 Libs 并将其路径填入对应的变量，主仓项目里直接使用这些变量去设置头文件目录和库路径即可，原理和 <code>find_library</code> 类似。</p><p>至此，Explosion 的编译速度得到了巨大提升，然而，因为库太多，调试 Explosion3rd 的 CI 却变成了噩梦，一想到后面还要调编一次两小时的 V8 就头疼 &mldr;&mldr;</p><h1 id=留坑>留坑</h1><p>手头还有一点新的思考，太晚了，先睡了，有空把念头落实了再记录下来，加油！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/explosion/>Explosion</a>
<a href=/tags/game/>Game</a>
<a href=/tags/graphics/>Graphics</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/post/40/><div class=article-details><h2 class=article-title>Explosion 开发笔记 (三)</h2></div></a></article><article><a href=/post/37/><div class=article-details><h2 class=article-title>Explosion 开发笔记 (二)</h2></div></a></article><article><a href=/post/35/><div class=article-details><h2 class=article-title>Explosion 开发笔记 (一)</h2></div></a></article><article><a href=/post/34/><div class=article-details><h2 class=article-title>UnrealEngine4 源码剖析 (二) 垃圾回收</h2></div></a></article><article><a href=/post/33/><div class=article-details><h2 class=article-title>UnrealEngine4 源码剖析 (一) UObject 概览及反射系统</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=FlyAndNotDown/KindemBlog issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;setUtterancesTheme(document.body.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2017 -
2024 Kindem的博客</section><section class=powerby>©2017-2021 Copyright Kindem<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.3.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>