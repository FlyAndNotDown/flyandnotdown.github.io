<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="利用四叉树优化 Displacement Mapping 的一个方案。"><meta name=keywords content="qdm,self,shadow"><title>GDC 笔记 - Quadtree Displacement Mapping with Height Blending</title><link rel=canonical href=https://www.kindem.xyz/post/53/><link rel=stylesheet href=/scss/style.min.css><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?a0c486208ba4751b6988ccc92f1479ee",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="GDC 笔记 - Quadtree Displacement Mapping with Height Blending"><meta property="og:description" content="利用四叉树优化 Displacement Mapping 的一个方案。"><meta property="og:url" content="https://www.kindem.xyz/post/53/"><meta property="og:site_name" content="Kindem的博客"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="GDC"><meta property="article:published_time" content="2022-03-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-15T00:00:00+00:00"><meta name=twitter:title content="GDC 笔记 - Quadtree Displacement Mapping with Height Blending"><meta name=twitter:description content="利用四叉树优化 Displacement Mapping 的一个方案。"><link rel="shortcut icon" href=#ZgotmplZ><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3YCH8P4PP"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3YCH8P4PP",{anonymize_ip:!1})}</script></head><body><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.body.dataset.scheme="dark":document.body.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_hu0f5c0aa158a4e8466efa1fc48b48096f_378948_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🎯</span></figure><h1 class=site-name><a href=https://www.kindem.xyz/>Kindem的博客</a></h1><h2 class=site-description>层楼终究误少年，自由早晚乱余生</h2></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><li><a href=/friends/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>友链</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://www.kindem.xyz/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%8A%80%E6%9C%AF/>技术</a></header><h2 class=article-title><a href=/post/53/>GDC 笔记 - Quadtree Displacement Mapping with Height Blending</a></h2><h3 class=article-subtitle>利用四叉树优化 Displacement Mapping 的一个方案。</h3><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Mar 15, 2022</time></footer></div></header><section class=article-content><blockquote><p>原文链接：<a class=link href=https://www.gamedevs.org/uploads/quadtree-displacement-mapping-with-height-blending.pdf target=_blank rel=noopener>Quadtree Displacement Mapping with Height Blending</a></p></blockquote><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/1.png data-size=1094x825><img src=/post/53/1.png srcset="/post/53/1_hu3309d8a02aace4e8153e9ffa6ce7fc70_2082751_480x0_resize_box_3.png 480w, /post/53/1_hu3309d8a02aace4e8153e9ffa6ce7fc70_2082751_1024x0_resize_box_3.png 1024w" width=1094 height=825 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/2.png data-size=1097x827><img src=/post/53/2.png srcset="/post/53/2_huce86bc389dad0325292cc9f42be0a617_492200_480x0_resize_box_3.png 480w, /post/53/2_huce86bc389dad0325292cc9f42be0a617_492200_1024x0_resize_box_3.png 1024w" width=1097 height=827 loading=lazy></a></figure></p><p>目录</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/3.png data-size=1100x830><img src=/post/53/3.png srcset="/post/53/3_hu0c880e077e2b3f4fd8df049039e5722d_500429_480x0_resize_box_3.png 480w, /post/53/3_hu0c880e077e2b3f4fd8df049039e5722d_500429_1024x0_resize_box_3.png 1024w" width=1100 height=830 loading=lazy></a></figure></p><p>下一代渲染的一些要素与目标。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/4.png data-size=1102x830><img src=/post/53/4.png srcset="/post/53/4_hu391dc5972bd278309e40032b75eb9bcf_495328_480x0_resize_box_3.png 480w, /post/53/4_hu391dc5972bd278309e40032b75eb9bcf_495328_1024x0_resize_box_3.png 1024w" width=1102 height=830 loading=lazy></a></figure></p><p>然而现实是现在的 Surface Rendering 差距甚远。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/5.png data-size=1099x830><img src=/post/53/5.png srcset="/post/53/5_hu7a9c2eae7d67f14319e2c2d06e6b4bb4_478475_480x0_resize_box_3.png 480w, /post/53/5_hu7a9c2eae7d67f14319e2c2d06e6b4bb4_478475_1024x0_resize_box_3.png 1024w" width=1099 height=830 loading=lazy></a></figure></p><p>地形的 Surface Rendering 是很费的，而且需要做混合，混合意味着不能拥有较高的几何复杂度。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/6.png data-size=1100x829><img src=/post/53/6.png srcset="/post/53/6_hu2326586733e11add006bce1eb439ea60_488942_480x0_resize_box_3.png 480w, /post/53/6_hu2326586733e11add006bce1eb439ea60_488942_1024x0_resize_box_3.png 1024w" width=1100 height=829 loading=lazy></a></figure></p><p>Surface 的几何细节包括体积、深度、各种频率的细节。他们结合起来可以产生一些其他的效果：深度视差、自阴影、光反应性。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/7.png data-size=1101x831><img src=/post/53/7.png srcset="/post/53/7_hu534a6e70ee772e704f5cb61d9262f376_506593_480x0_resize_box_3.png 480w, /post/53/7_hu534a6e70ee772e704f5cb61d9262f376_506593_1024x0_resize_box_3.png 1024w" width=1101 height=831 loading=lazy></a></figure></p><p>Surface Rendering 要实现光照交互依赖 Surface 的微观结构，目前已经有一些理论研究（比如烘焙 Terrance BDRF）了。要体现出几何的复杂性，可以通过修改三角面或者走光追。但是三角面相关的方法都比较费，比如直接增加面数，顶点的 Transform 和显存开销都会相应增加，更实用的做法是实用 Tessellation 在管线中倍增三角面。</p><p><figure style=flex-grow:131;flex-basis:316px><a href=/post/53/8.png data-size=1098x832><img src=/post/53/8.png srcset="/post/53/8_hu864bd24162186c47f77793c0dc298ef8_510091_480x0_resize_box_3.png 480w, /post/53/8_hu864bd24162186c47f77793c0dc298ef8_510091_1024x0_resize_box_3.png 1024w" width=1098 height=832 loading=lazy></a></figure></p><p>做这套方案的动机：</p><ul><li>应对不同的 Surface：地形、静态/动态物体</li><li>高性能：支持当前的硬件</li><li>最小化显存开销：开销与传统的 Normal Mapping 相当，能在当前的主机平台顺利运行</li></ul><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/9.png data-size=1102x830><img src=/post/53/9.png srcset="/post/53/9_hudf0e8b5170ae36c318ad23931fa7770b_471136_480x0_resize_box_3.png 480w, /post/53/9_hudf0e8b5170ae36c318ad23931fa7770b_471136_1024x0_resize_box_3.png 1024w" width=1102 height=830 loading=lazy></a></figure></p><p>所以这套方案需要支持：</p><ul><li>获取任意角度下的精确深度</li><li>自阴影</li><li>AO</li><li>快速、准确的混合</li></ul><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/10.png data-size=1097x827><img src=/post/53/10.png srcset="/post/53/10_hueebf6555f404da407035edd47ae11750_1749836_480x0_resize_box_3.png 480w, /post/53/10_hueebf6555f404da407035edd47ae11750_1749836_1024x0_resize_box_3.png 1024w" width=1097 height=827 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/11.png data-size=1097x828><img src=/post/53/11.png srcset="/post/53/11_huc06005b22024d020421ad31055e61289_1667779_480x0_resize_box_3.png 480w, /post/53/11_huc06005b22024d020421ad31055e61289_1667779_1024x0_resize_box_3.png 1024w" width=1097 height=828 loading=lazy></a></figure></p><p>效果对比图。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/12.png data-size=1101x832><img src=/post/53/12.png srcset="/post/53/12_hu4af12cd30794216eb0b50a01ab74500b_480660_480x0_resize_box_3.png 480w, /post/53/12_hu4af12cd30794216eb0b50a01ab74500b_480660_1024x0_resize_box_3.png 1024w" width=1101 height=832 loading=lazy></a></figure></p><p>现有的提高深度复杂度的解决方案无非两种：</p><ul><li>寻找真正的 Surface 的深度，即寻找 View Ray 和 Height Field 的真正交点</li><li>通过计算好的 Depth Offset 来进行光照计算</li></ul><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/13.png data-size=1107x831><img src=/post/53/13.png srcset="/post/53/13_huabf3b5cf8f26701e6c48f74a60f92d9c_247130_480x0_resize_box_3.png 480w, /post/53/13_huabf3b5cf8f26701e6c48f74a60f92d9c_247130_1024x0_resize_box_3.png 1024w" width=1107 height=831 loading=lazy></a></figure></p><p>比如上面这张图，在无视高度细节的情况下交点实际上是错误的。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/14.png data-size=1100x830><img src=/post/53/14.png srcset="/post/53/14_hu4f4dd8466f21d167aa3ac66c58871994_260674_480x0_resize_box_3.png 480w, /post/53/14_hu4f4dd8466f21d167aa3ac66c58871994_260674_1024x0_resize_box_3.png 1024w" width=1100 height=830 loading=lazy></a></figure></p><p>正确的交点应该是图中虚线和 View Ray 的交点。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/15.png data-size=1101x830><img src=/post/53/15.png srcset="/post/53/15_hu4e8bffdd9c04fd1740155c2dae193a37_485385_480x0_resize_box_3.png 480w, /post/53/15_hu4e8bffdd9c04fd1740155c2dae193a37_485385_1024x0_resize_box_3.png 1024w" width=1101 height=830 loading=lazy></a></figure></p><p>一种做法是对 Height Field 数据做 Ray Tracing，这意味着额外的显存消耗。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/16.png data-size=1101x832><img src=/post/53/16.png srcset="/post/53/16_hua6f2bf59f421d521946f41fc5f198cf6_462525_480x0_resize_box_3.png 480w, /post/53/16_hua6f2bf59f421d521946f41fc5f198cf6_462525_1024x0_resize_box_3.png 1024w" width=1101 height=832 loading=lazy></a></figure></p><p>Relief Mapping (RM) 和 Parallax Oclussion Mapping (POM) 都是光追做法。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/17.png data-size=1101x829><img src=/post/53/17.png srcset="/post/53/17_hufacb07774c859416581bcbf924b3c6ab_265998_480x0_resize_box_3.png 480w, /post/53/17_hufacb07774c859416581bcbf924b3c6ab_265998_1024x0_resize_box_3.png 1024w" width=1101 height=829 loading=lazy></a></figure></p><p>传统的固定步长的 Linear Search Ray Tracing，可以看见 Tracing 的结果（实箭头的终点）和正确的交点还是有一定的误差。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/18.png data-size=1101x829><img src=/post/53/18.png srcset="/post/53/18_hu4aca259692f2b4beb47cbb3efc8f78ea_271698_480x0_resize_box_3.png 480w, /post/53/18_hu4aca259692f2b4beb47cbb3efc8f78ea_271698_1024x0_resize_box_3.png 1024w" width=1101 height=829 loading=lazy></a></figure></p><p>POM 则是在 Linear Search 的基础上加了一次线性近似。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/19.png data-size=1102x830><img src=/post/53/19.png srcset="/post/53/19_hu7245c9f8d5d98aec9900ffb9a24599b9_269179_480x0_resize_box_3.png 480w, /post/53/19_hu7245c9f8d5d98aec9900ffb9a24599b9_269179_1024x0_resize_box_3.png 1024w" width=1102 height=830 loading=lazy></a></figure></p><p>如图所示，Linear Search 有一个问题，就是步长太长的话可能导致求交出错。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/20.png data-size=1100x829><img src=/post/53/20.png srcset="/post/53/20_hu990c5e85789076d9ba4f98c0307d63d7_1313392_480x0_resize_box_3.png 480w, /post/53/20_hu990c5e85789076d9ba4f98c0307d63d7_1313392_1024x0_resize_box_3.png 1024w" width=1100 height=829 loading=lazy></a></figure></p><p>上面这张图就是步长设置不对的情况。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/21.png data-size=1101x833><img src=/post/53/21.png srcset="/post/53/21_huf70f400fc50563bc4e167e55f0c3b58f_508617_480x0_resize_box_3.png 480w, /post/53/21_huf70f400fc50563bc4e167e55f0c3b58f_508617_1024x0_resize_box_3.png 1024w" width=1101 height=833 loading=lazy></a></figure></p><p>此外还有一些基于距离场的预处理的方案:</p><ul><li>Per-pixel Displacement with Distance Function</li><li>Cone Step Mapping</li><li>Relaxed Cone Step Mapping</li></ul><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/22.png data-size=1104x830><img src=/post/53/22.png srcset="/post/53/22_hu161438a8ef3aae70d171a3a6644403b2_468420_480x0_resize_box_3.png 480w, /post/53/22_hu161438a8ef3aae70d171a3a6644403b2_468420_1024x0_resize_box_3.png 1024w" width=1104 height=830 loading=lazy></a></figure></p><p>因为是预处理，所以可以包含更多的信息来做一些额外的事情。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/23.png data-size=1104x830><img src=/post/53/23.png srcset="/post/53/23_hub44ded327991c7ede0fcee99731c9c0e_502275_480x0_resize_box_3.png 480w, /post/53/23_hub44ded327991c7ede0fcee99731c9c0e_502275_1024x0_resize_box_3.png 1024w" width=1104 height=830 loading=lazy></a></figure></p><p>Quadtree Displacement Mapping (QDM) 算法，用四叉树来存储到高度场基准平面的最小深度。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/24.png data-size=1100x831><img src=/post/53/24.png srcset="/post/53/24_hudc95693eeea05accbc64967632b4fff9_554177_480x0_resize_box_3.png 480w, /post/53/24_hudc95693eeea05accbc64967632b4fff9_554177_1024x0_resize_box_3.png 1024w" width=1100 height=831 loading=lazy></a></figure></p><p>四叉树结构简单，对应到硬件实现是 Mipmap 采样会更快、显存开销小。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/25.png data-size=1101x832><img src=/post/53/25.png srcset="/post/53/25_hua66106bbdd39d74c7bad0c41e3b83dcc_503621_480x0_resize_box_3.png 480w, /post/53/25_hua66106bbdd39d74c7bad0c41e3b83dcc_503621_1024x0_resize_box_3.png 1024w" width=1101 height=832 loading=lazy></a></figure></p><p>性能足以运行时生成。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/26.png data-size=1106x833><img src=/post/53/26.png srcset="/post/53/26_hu084cb9e2d45d84c6e13e6f7a5723a614_485214_480x0_resize_box_3.png 480w, /post/53/26_hu084cb9e2d45d84c6e13e6f7a5723a614_485214_1024x0_resize_box_3.png 1024w" width=1106 height=833 loading=lazy></a></figure></p><p>用 QDM 做 Ray Tracing 的时候需要从最高级 Mip 到最低级 Mip 遍历四叉树，最后用最低级 Mip 来计算交点。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/27.png data-size=1105x834><img src=/post/53/27.png srcset="/post/53/27_hu8cde4745701c667d3f0b224b2ac4f28e_488329_480x0_resize_box_3.png 480w, /post/53/27_hu8cde4745701c667d3f0b224b2ac4f28e_488329_1024x0_resize_box_3.png 1024w" width=1105 height=834 loading=lazy></a></figure></p><p>算法伪代码，获取当前位置投影在当前 Hierarchy_Level 中的最大 Depth，如果 Ray_Depth &lt; Depth，就沿着 Ray 步进到最接近的交点，否则的话就降一级 Hierarchy_Level 重复上面的操作直到 当 Hierarchy_Level ≤ 0。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/28.png data-size=1099x828><img src=/post/53/28.png srcset="/post/53/28_hu1a75aaf3d121358fc803c746cab44e7a_226344_480x0_resize_box_3.png 480w, /post/53/28_hu1a75aaf3d121358fc803c746cab44e7a_226344_1024x0_resize_box_3.png 1024w" width=1099 height=828 loading=lazy></a></figure></p><p><figure style=flex-grow:156;flex-basis:374px><a href=/post/53/29.png data-size=1117x715><img src=/post/53/29.png srcset="/post/53/29_hub11bbf9bf3830192e6d262043d7f9514_228543_480x0_resize_box_3.png 480w, /post/53/29_hub11bbf9bf3830192e6d262043d7f9514_228543_1024x0_resize_box_3.png 1024w" width=1117 height=715 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/30.png data-size=1101x826><img src=/post/53/30.png srcset="/post/53/30_hu1914fef6f742898af956d4f88a829dca_225509_480x0_resize_box_3.png 480w, /post/53/30_hu1914fef6f742898af956d4f88a829dca_225509_1024x0_resize_box_3.png 1024w" width=1101 height=826 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/31.png data-size=1097x826><img src=/post/53/31.png srcset="/post/53/31_hu1ef90660383f52f1f2853d51c8cd0cbb_227665_480x0_resize_box_3.png 480w, /post/53/31_hu1ef90660383f52f1f2853d51c8cd0cbb_227665_1024x0_resize_box_3.png 1024w" width=1097 height=826 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/32.png data-size=1097x829><img src=/post/53/32.png srcset="/post/53/32_hu9f6931d1f8b41c6c1a5b403120e02a3e_226573_480x0_resize_box_3.png 480w, /post/53/32_hu9f6931d1f8b41c6c1a5b403120e02a3e_226573_1024x0_resize_box_3.png 1024w" width=1097 height=829 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:316px><a href=/post/53/33.png data-size=1096x830><img src=/post/53/33.png srcset="/post/53/33_hu52283a14320790864ef50347a1c8f743_225084_480x0_resize_box_3.png 480w, /post/53/33_hu52283a14320790864ef50347a1c8f743_225084_1024x0_resize_box_3.png 1024w" width=1096 height=830 loading=lazy></a></figure></p><p>QDM 的构建，由最低级的 Mip 往最高级 Mip 逐级构建，不过不能直接用硬件生成，因为每一级 Mip 要取低级 Mip 四个 Texel 的最大值。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/34.png data-size=1100x828><img src=/post/53/34.png srcset="/post/53/34_huddf48063ab6707adf5839137478d9a88_231524_480x0_resize_box_3.png 480w, /post/53/34_huddf48063ab6707adf5839137478d9a88_231524_1024x0_resize_box_3.png 1024w" width=1100 height=828 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/35.png data-size=1099x830><img src=/post/53/35.png srcset="/post/53/35_hu40f98e06778768cfe4a06d14596af19b_231093_480x0_resize_box_3.png 480w, /post/53/35_hu40f98e06778768cfe4a06d14596af19b_231093_1024x0_resize_box_3.png 1024w" width=1099 height=830 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/36.png data-size=1100x829><img src=/post/53/36.png srcset="/post/53/36_hu87c0a6d0a2b49053c82ae480b436734e_231839_480x0_resize_box_3.png 480w, /post/53/36_hu87c0a6d0a2b49053c82ae480b436734e_231839_1024x0_resize_box_3.png 1024w" width=1100 height=829 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/37.png data-size=1098x825><img src=/post/53/37.png srcset="/post/53/37_hu46632a78c3fcf66504d49d3fbed70af4_234631_480x0_resize_box_3.png 480w, /post/53/37_hu46632a78c3fcf66504d49d3fbed70af4_234631_1024x0_resize_box_3.png 1024w" width=1098 height=825 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/38.png data-size=1099x829><img src=/post/53/38.png srcset="/post/53/38_hue76e72b4b58f47e241899f9db6a03934_235281_480x0_resize_box_3.png 480w, /post/53/38_hue76e72b4b58f47e241899f9db6a03934_235281_1024x0_resize_box_3.png 1024w" width=1099 height=829 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:319px><a href=/post/53/39.png data-size=1098x826><img src=/post/53/39.png srcset="/post/53/39_hu1cb282c6bb0e336653b1064a3e9c18c5_235570_480x0_resize_box_3.png 480w, /post/53/39_hu1cb282c6bb0e336653b1064a3e9c18c5_235570_1024x0_resize_box_3.png 1024w" width=1098 height=826 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/40.png data-size=1099x828><img src=/post/53/40.png srcset="/post/53/40_huaa54cf746ea37d355c7522217c75685c_237508_480x0_resize_box_3.png 480w, /post/53/40_huaa54cf746ea37d355c7522217c75685c_237508_1024x0_resize_box_3.png 1024w" width=1099 height=828 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/41.png data-size=1104x830><img src=/post/53/41.png srcset="/post/53/41_hu321b8be6834c53faaa3e688926d9b282_235877_480x0_resize_box_3.png 480w, /post/53/41_hu321b8be6834c53faaa3e688926d9b282_235877_1024x0_resize_box_3.png 1024w" width=1104 height=830 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/42.png data-size=1100x828><img src=/post/53/42.png srcset="/post/53/42_huddf48063ab6707adf5839137478d9a88_236044_480x0_resize_box_3.png 480w, /post/53/42_huddf48063ab6707adf5839137478d9a88_236044_1024x0_resize_box_3.png 1024w" width=1100 height=828 loading=lazy></a></figure></p><p>对照上面的算法来看图就容易理解了。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/43.png data-size=1098x827><img src=/post/53/43.png srcset="/post/53/43_hub5c64356ce85b8282752e09aff225756_234880_480x0_resize_box_3.png 480w, /post/53/43_hub5c64356ce85b8282752e09aff225756_234880_1024x0_resize_box_3.png 1024w" width=1098 height=827 loading=lazy></a></figure></p><p>最后再参考 POM 做一次线性近似。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/44.png data-size=1101x833><img src=/post/53/44.png srcset="/post/53/44_hu24fd87667fab46d7ae5508fe3ef3f8f3_545705_480x0_resize_box_3.png 480w, /post/53/44_hu24fd87667fab46d7ae5508fe3ef3f8f3_545705_1024x0_resize_box_3.png 1024w" width=1101 height=833 loading=lazy></a></figure></p><p>QDM Ray Tracing 是代数方式在进行求交测试，遍历的是离散数据。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/45.png data-size=1100x831><img src=/post/53/45.png srcset="/post/53/45_hu60b901ce3be659812f4d0afcc90537a5_469505_480x0_resize_box_3.png 480w, /post/53/45_hu60b901ce3be659812f4d0afcc90537a5_469505_1024x0_resize_box_3.png 1024w" width=1100 height=831 loading=lazy></a></figure></p><p>QDM 仍然有一些优化空间。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/46.png data-size=1101x831><img src=/post/53/46.png srcset="/post/53/46_hu4e8524b075908239b0973da9e246c3a5_503597_480x0_resize_box_3.png 480w, /post/53/46_hu4e8524b075908239b0973da9e246c3a5_503597_1024x0_resize_box_3.png 1024w" width=1101 height=831 loading=lazy></a></figure></p><p>因为 QDM 的 Level 0 是点采样即离散数据，这意味着越接近 Surface，效果越越差，需要额外的提升效果的手段，通常是用线性逼近求交（上面提到的那个）。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/47.png data-size=1099x827><img src=/post/53/47.png srcset="/post/53/47_hub28cb06cc82d72de99dc10de39753c5c_470039_480x0_resize_box_3.png 480w, /post/53/47_hub28cb06cc82d72de99dc10de39753c5c_470039_1024x0_resize_box_3.png 1024w" width=1099 height=827 loading=lazy></a></figure></p><p>正常 QDM 的时间复杂度是 O(log(n))，这还是不够快，所以需要限制最大的迭代次数。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/48.png data-size=1101x831><img src=/post/53/48.png srcset="/post/53/48_hu8799d4243315ee13f0626ef45114aa3c_538583_480x0_resize_box_3.png 480w, /post/53/48_hu8799d4243315ee13f0626ef45114aa3c_538583_1024x0_resize_box_3.png 1024w" width=1101 height=831 loading=lazy></a></figure></p><p>QDM 在一定条件下会退化成 Linear Search，典型的场景就是在特征边缘，Ray 已经达到了 Level 0，由于 QDM 没办法在遍历时往更高的 Level 走，所以 Ray 再往前算法就跟 Linear Search 没区别了。解决方案就是在穿越 Cel 的时候往上走一级。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/49.png data-size=1104x834><img src=/post/53/49.png srcset="/post/53/49_hu5c1ec6bbec4f053584c4b6128ecec0c8_527816_480x0_resize_box_3.png 480w, /post/53/49_hu5c1ec6bbec4f053584c4b6128ecec0c8_527816_1024x0_resize_box_3.png 1024w" width=1104 height=834 loading=lazy></a></figure></p><p>QDM 不能用传统的 MipMapping（猜测是 QDM 不能直接随距离变化，就算距离拉远了，还是需要一定程度的精度？）。相应的，需要根据当前的 Mip Level 来限制 LOD Level 的最大值。然后还需要动态地调整迭代上限（根据 Normal 和 View 向量的夹角）。还有就是根据 Camera Space 的 Z 来调整 QDM Depth Fade 的比例（最远处就是只用 Normal Mapping 了）。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/50.png data-size=1103x832><img src=/post/53/50.png srcset="/post/53/50_hu4646e0ddbeb7427a8155aa2aa4895cd8_509904_480x0_resize_box_3.png 480w, /post/53/50_hu4646e0ddbeb7427a8155aa2aa4895cd8_509904_1024x0_resize_box_3.png 1024w" width=1103 height=832 loading=lazy></a></figure></p><p>QDM 本身其实是一个离散数据集（纹素），如果需要提高精度的话就要使用未压缩的纹理。当然如果能保证整数运算精确的话，是可以使用压缩数据的，DXT5 alpha 插值的误差就可以接受。</p><p><figure style=flex-grow:131;flex-basis:316px><a href=/post/53/51.png data-size=1098x832><img src=/post/53/51.png srcset="/post/53/51_hub4ace28179d6331b7e5188e481e7727e_523127_480x0_resize_box_3.png 480w, /post/53/51_hub4ace28179d6331b7e5188e481e7727e_523127_1024x0_resize_box_3.png 1024w" width=1098 height=832 loading=lazy></a></figure></p><p>总结下 QDM 的优点：</p><ul><li>任何场景下都是准确的</li><li>运算快、Scalable</li><li>额外显存消耗小</li><li>预处理快</li><li>可以调整迭代次数来平衡性能与质量</li><li>涵盖四叉树的其他优点</li></ul><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/52.png data-size=1098x828><img src=/post/53/52.png srcset="/post/53/52_hu50c213b011a5f122ad37d0b63581ecae_502002_480x0_resize_box_3.png 480w, /post/53/52_hu50c213b011a5f122ad37d0b63581ecae_502002_1024x0_resize_box_3.png 1024w" width=1098 height=828 loading=lazy></a></figure></p><p>缺点：</p><ul><li>每次迭代中更慢了</li><li>使用 text2DLod 采样时是随机访问，在现在的硬件上很慢</li><li>Depth 跨度较小、分辨率较低时效果不够好</li></ul><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/53.png data-size=1103x834><img src=/post/53/53.png srcset="/post/53/53_hud56d1955e86101ff4eae72deb464f8a5_467171_480x0_resize_box_3.png 480w, /post/53/53_hud56d1955e86101ff4eae72deb464f8a5_467171_1024x0_resize_box_3.png 1024w" width=1103 height=834 loading=lazy></a></figure></p><p>理论的时间复杂度。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/54.png data-size=1099x829><img src=/post/53/54.png srcset="/post/53/54_hu90692c41c8013ea6227b3415a72acecf_1083585_480x0_resize_box_3.png 480w, /post/53/54_hu90692c41c8013ea6227b3415a72acecf_1083585_1024x0_resize_box_3.png 1024w" width=1099 height=829 loading=lazy></a></figure></p><p>实际上达到收敛状态所需要的迭代次数，可见 QDM 远远强于 POM。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/55.png data-size=1102x831><img src=/post/53/55.png srcset="/post/53/55_huf802f9e5a60635652d9158c859940d45_538264_480x0_resize_box_3.png 480w, /post/53/55_huf802f9e5a60635652d9158c859940d45_538264_1024x0_resize_box_3.png 1024w" width=1102 height=831 loading=lazy></a></figure></p><p>下一页的数据展示了 POM 和 QDM 在实际游戏场景中的性能差异。CSM 和 RCSM 因为预处理时间的原因，不太适合实际游戏？</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/56.png data-size=1103x834><img src=/post/53/56.png srcset="/post/53/56_hu05283939b18f317c13d7f58af3b62369_522513_480x0_resize_box_3.png 480w, /post/53/56_hu05283939b18f317c13d7f58af3b62369_522513_1024x0_resize_box_3.png 1024w" width=1103 height=834 loading=lazy></a></figure></p><p>POM 与 QDM 的性能对比。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/57.png data-size=1098x829><img src=/post/53/57.png srcset="/post/53/57_hu3c1501a5a6636175195f8cc032193130_1518061_480x0_resize_box_3.png 480w, /post/53/57_hu3c1501a5a6636175195f8cc032193130_1518061_1024x0_resize_box_3.png 1024w" width=1098 height=829 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/58.png data-size=1097x830><img src=/post/53/58.png srcset="/post/53/58_hu6a01a34d6ce87aa2613fbe76caf56219_1525448_480x0_resize_box_3.png 480w, /post/53/58_hu6a01a34d6ce87aa2613fbe76caf56219_1525448_1024x0_resize_box_3.png 1024w" width=1097 height=830 loading=lazy></a></figure></p><p>Depth Scale 1.0 对比。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/59.png data-size=1096x829><img src=/post/53/59.png srcset="/post/53/59_hue47e307bfbd7f237e2aa9e115e14d099_1500056_480x0_resize_box_3.png 480w, /post/53/59_hue47e307bfbd7f237e2aa9e115e14d099_1500056_1024x0_resize_box_3.png 1024w" width=1096 height=829 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/60.png data-size=1098x828><img src=/post/53/60.png srcset="/post/53/60_hu03538c20f6463e242356351f7f5a2fdd_1527211_480x0_resize_box_3.png 480w, /post/53/60_hu03538c20f6463e242356351f7f5a2fdd_1527211_1024x0_resize_box_3.png 1024w" width=1098 height=828 loading=lazy></a></figure></p><p>Depth Scale 1.5。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/61.png data-size=1098x828><img src=/post/53/61.png srcset="/post/53/61_hu0c8521b405b7f62b92b4d98f44d8095c_1431145_480x0_resize_box_3.png 480w, /post/53/61_hu0c8521b405b7f62b92b4d98f44d8095c_1431145_1024x0_resize_box_3.png 1024w" width=1098 height=828 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/62.png data-size=1099x827><img src=/post/53/62.png srcset="/post/53/62_hu4591cfb8d7ee196977168bbdb2ba2307_1523497_480x0_resize_box_3.png 480w, /post/53/62_hu4591cfb8d7ee196977168bbdb2ba2307_1523497_1024x0_resize_box_3.png 1024w" width=1099 height=827 loading=lazy></a></figure></p><p>Depth Scale 5.0。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/63.png data-size=1102x831><img src=/post/53/63.png srcset="/post/53/63_hu7858c644922c9d127b57762cfe1cebf5_476576_480x0_resize_box_3.png 480w, /post/53/63_hu7858c644922c9d127b57762cfe1cebf5_476576_1024x0_resize_box_3.png 1024w" width=1102 height=831 loading=lazy></a></figure></p><p>极限场景下的测试对比。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/64.png data-size=1103x832><img src=/post/53/64.png srcset="/post/53/64_hue7565d3df0f762d8bb1099eb57c3ca55_518305_480x0_resize_box_3.png 480w, /post/53/64_hue7565d3df0f762d8bb1099eb57c3ca55_518305_1024x0_resize_box_3.png 1024w" width=1103 height=832 loading=lazy></a></figure></p><p>HeightMap 的一个特性就是可以在 Surface 上产生自阴影。计算自阴影的办法就是 ViewRay 与 Surface 的交点 P 能否从光的位置 L 被看见，要完成这个计算，可以从 L → P 的方向开始做 Ray Tracing，如果与 HeightField 相交，就说明 P 在阴影中。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/65.png data-size=1107x831><img src=/post/53/65.png srcset="/post/53/65_hu7632b614dad04b392e895052bbb24579_253675_480x0_resize_box_3.png 480w, /post/53/65_hu7632b614dad04b392e895052bbb24579_253675_1024x0_resize_box_3.png 1024w" width=1107 height=831 loading=lazy></a></figure></p><p>对照这幅图来理解。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/66.png data-size=1100x830><img src=/post/53/66.png srcset="/post/53/66_hu39e3ef56e18a05f79d11fcc5bda965c6_534100_480x0_resize_box_3.png 480w, /post/53/66_hu39e3ef56e18a05f79d11fcc5bda965c6_534100_1024x0_resize_box_3.png 1024w" width=1100 height=830 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:319px><a href=/post/53/67.png data-size=1094x823><img src=/post/53/67.png srcset="/post/53/67_hu7fba05493ebab449903bd2e4ab72c8b5_524583_480x0_resize_box_3.png 480w, /post/53/67_hu7fba05493ebab449903bd2e4ab72c8b5_524583_1024x0_resize_box_3.png 1024w" width=1094 height=823 loading=lazy></a></figure></p><p>按照这种方法做 Ray Tracing 成本较高，每个采样点都要进行一次 Light Ray 的 Ray Tracing。我们可以转换下思路，通过计算水平可见性来获取自阴影（POM 那篇论文里的做法）。</p><p><figure style=flex-grow:133;flex-basis:321px><a href=/post/53/68.png data-size=817x610><img src=/post/53/68.png srcset="/post/53/68_hu36bb08cdb49bf7b4c1a12c90c8b17402_74382_480x0_resize_box_3.png 480w, /post/53/68_hu36bb08cdb49bf7b4c1a12c90c8b17402_74382_1024x0_resize_box_3.png 1024w" width=817 height=610 loading=lazy></a></figure></p><p>从 POM 原 Paper 那盗了张图，要计算硬阴影可以从 View Ray 的命中点出发，沿着 Light Ray 计算是否被遮挡，被遮挡则在阴影中。</p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/69.png data-size=817x612><img src=/post/53/69.png srcset="/post/53/69_hue22a757a9c40134737d8654ef622a5c3_95621_480x0_resize_box_3.png 480w, /post/53/69_hue22a757a9c40134737d8654ef622a5c3_95621_1024x0_resize_box_3.png 1024w" width=817 height=612 loading=lazy></a></figure></p><p>计算软阴影则可以从 View Ray 的命中点 h0 出发，沿着 Light Vector 在 Height Field 上做一系列采样，然后求出遮挡系数 hi，以最大的遮挡系数来求软阴影的值（图中的这个公式只是说明为什么这两者有关系，不是用来计算的）。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/70.png data-size=1088x817><img src=/post/53/70.png srcset="/post/53/70_hu2f90c701b4397122ca5447d7052fbfd5_287686_480x0_resize_box_3.png 480w, /post/53/70_hu2f90c701b4397122ca5447d7052fbfd5_287686_1024x0_resize_box_3.png 1024w" width=1088 height=817 loading=lazy></a></figure></p><p>再拿这张图跟上面那张图中 Blocker Height 的说明对比一下就清楚了。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/71.png data-size=1086x816><img src=/post/53/71.png srcset="/post/53/71_hu06857f886fffb5f8a9beb7b414d53099_538659_480x0_resize_box_3.png 480w, /post/53/71_hu06857f886fffb5f8a9beb7b414d53099_538659_1024x0_resize_box_3.png 1024w" width=1086 height=816 loading=lazy></a></figure></p><p>用 POM 计算软阴影的 Shader。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/72.png data-size=1086x815><img src=/post/53/72.png srcset="/post/53/72_hucf2e54cc9c846a817a7a277b2382a478_1438650_480x0_resize_box_3.png 480w, /post/53/72_hucf2e54cc9c846a817a7a277b2382a478_1438650_1024x0_resize_box_3.png 1024w" width=1086 height=815 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/73.png data-size=1084x815><img src=/post/53/73.png srcset="/post/53/73_hu1c32d0c97ce8763c30b45cb5312bfc5f_1359956_480x0_resize_box_3.png 480w, /post/53/73_hu1c32d0c97ce8763c30b45cb5312bfc5f_1359956_1024x0_resize_box_3.png 1024w" width=1084 height=815 loading=lazy></a></figure></p><p>开关的对比。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/74.png data-size=1085x818><img src=/post/53/74.png srcset="/post/53/74_hu14014d8011d45b74520f53c073468167_561500_480x0_resize_box_3.png 480w, /post/53/74_hu14014d8011d45b74520f53c073468167_561500_1024x0_resize_box_3.png 1024w" width=1085 height=818 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/75.png data-size=814x610><img src=/post/53/75.png srcset="/post/53/75_hu95ce7c37ada8a34b8a052e211049347d_169060_480x0_resize_box_3.png 480w, /post/53/75_hu95ce7c37ada8a34b8a052e211049347d_169060_1024x0_resize_box_3.png 1024w" width=814 height=610 loading=lazy></a></figure></p><p>QDM 版本的自阴影。沿 Light Ray 方向里 View Ray 命中点较远的采样可以用高 Mip 替换，可以进一步提高速度。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/76.png data-size=1083x817><img src=/post/53/76.png srcset="/post/53/76_hude65863243260a9659587056699ac060_535954_480x0_resize_box_3.png 480w, /post/53/76_hude65863243260a9659587056699ac060_535954_1024x0_resize_box_3.png 1024w" width=1083 height=817 loading=lazy></a></figure></p><p>跟上面的 Shader 对比一下就知道了，w1-w5 是给美术调整效果用的。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/77.png data-size=1091x821><img src=/post/53/77.png srcset="/post/53/77_huace0556b7a447bcec18fe6b1f52a1c66_529185_480x0_resize_box_3.png 480w, /post/53/77_huace0556b7a447bcec18fe6b1f52a1c66_529185_1024x0_resize_box_3.png 1024w" width=1091 height=821 loading=lazy></a></figure></p><p>保证质量的同时提速，o(n) → o(logn)。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/78.png data-size=1085x815><img src=/post/53/78.png srcset="/post/53/78_hub3728120a915a4b67db8143c5ff4861e_1833860_480x0_resize_box_3.png 480w, /post/53/78_hub3728120a915a4b67db8143c5ff4861e_1833860_1024x0_resize_box_3.png 1024w" width=1085 height=815 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/79.png data-size=1084x814><img src=/post/53/79.png srcset="/post/53/79_huda44ddb2a3dfdb068c99fc5444336b61_1851616_480x0_resize_box_3.png 480w, /post/53/79_huda44ddb2a3dfdb068c99fc5444336b61_1851616_1024x0_resize_box_3.png 1024w" width=1084 height=814 loading=lazy></a></figure></p><p>开关对比。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/80.png data-size=1088x818><img src=/post/53/80.png srcset="/post/53/80_hu8d9ff91888fd69f1869fcc6ad9d75062_520893_480x0_resize_box_3.png 480w, /post/53/80_hu8d9ff91888fd69f1869fcc6ad9d75062_520893_1024x0_resize_box_3.png 1024w" width=1088 height=818 loading=lazy></a></figure></p><p>AO，简单提了下，跟 Self Shadowing 的计算类似，也可以用类似的手法处理，并不需要每一帧都计算，只需要在 Height Field 变化时计算即可，对提升大世界地形的效果尤其有效。</p><p><figure style=flex-grow:132;flex-basis:319px><a href=/post/53/81.png data-size=1085x816><img src=/post/53/81.png srcset="/post/53/81_hud5fa52b84662b655e9b5aa88eb15beba_479613_480x0_resize_box_3.png 480w, /post/53/81_hud5fa52b84662b655e9b5aa88eb15beba_479613_1024x0_resize_box_3.png 1024w" width=1085 height=816 loading=lazy></a></figure></p><p>Surface Blending，主要用在地形渲染，就是 Alpha Blending 的泛化版，对每一种材质给一个权重，最后加权混合。他这里说的使用顶点色做权重，一般更常用的是提供一张单独的 WeightMap。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/82.png data-size=1085x818><img src=/post/53/82.png srcset="/post/53/82_hu6997719f9f385d4aeca6cbaea8fdfe15_536189_480x0_resize_box_3.png 480w, /post/53/82_hu6997719f9f385d4aeca6cbaea8fdfe15_536189_1024x0_resize_box_3.png 1024w" width=1085 height=818 loading=lazy></a></figure></p><p>在 Surface Blending 中一般不会采用 Alpha Blending，现实生活中的 Surface 不会这样 Blending，实际上在游戏中还是有用的，一般是用来做一些附着材质的标记，比如湿度、积雪度等。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/83.png data-size=1084x817><img src=/post/53/83.png srcset="/post/53/83_hu06f0837a4f60e2f0585350df9fcdd0d3_547044_480x0_resize_box_3.png 480w, /post/53/83_hu06f0837a4f60e2f0585350df9fcdd0d3_547044_1024x0_resize_box_3.png 1024w" width=1084 height=817 loading=lazy></a></figure></p><p>更常用的一种混合方法是 Height Blending，也是老生常谈的混合方式了，在 Weight Blending 的基础上加上高度，从而在混合的材质间产生穿插的效果。</p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/84.png data-size=1086x812><img src=/post/53/84.png srcset="/post/53/84_hu16252d16dc573427c53900091d589a6e_749912_480x0_resize_box_3.png 480w, /post/53/84_hu16252d16dc573427c53900091d589a6e_749912_1024x0_resize_box_3.png 1024w" width=1086 height=812 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/85.png data-size=1085x814><img src=/post/53/85.png srcset="/post/53/85_hue6184db43ea8e0f4cfab488a4d3b56c4_1890246_480x0_resize_box_3.png 480w, /post/53/85_hue6184db43ea8e0f4cfab488a4d3b56c4_1890246_1024x0_resize_box_3.png 1024w" width=1085 height=814 loading=lazy></a></figure></p><p>混合效果。</p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/86.png data-size=1088x815><img src=/post/53/86.png srcset="/post/53/86_hu45b78f486a34df87b28503086796f0bd_505042_480x0_resize_box_3.png 480w, /post/53/86_hu45b78f486a34df87b28503086796f0bd_505042_1024x0_resize_box_3.png 1024w" width=1088 height=815 loading=lazy></a></figure></p><p>HB 的一些特点。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/87.png data-size=1086x818><img src=/post/53/87.png srcset="/post/53/87_hu5772cdedac89c48ba3d46866586c1b27_530567_480x0_resize_box_3.png 480w, /post/53/87_hu5772cdedac89c48ba3d46866586c1b27_530567_1024x0_resize_box_3.png 1024w" width=1086 height=818 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/88.png data-size=1087x816><img src=/post/53/88.png srcset="/post/53/88_hua6e3ff95eb3bc010e87029eafc17cc85_521114_480x0_resize_box_3.png 480w, /post/53/88_hua6e3ff95eb3bc010e87029eafc17cc85_521114_1024x0_resize_box_3.png 1024w" width=1087 height=816 loading=lazy></a></figure></p><p>使用 HB 的时候对 Surface 会造成一定影响（修改其高度）。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/89.png data-size=1086x815><img src=/post/53/89.png srcset="/post/53/89_huf057d9a506af7cc270217a1a23331e3e_294453_480x0_resize_box_3.png 480w, /post/53/89_huf057d9a506af7cc270217a1a23331e3e_294453_1024x0_resize_box_3.png 1024w" width=1086 height=815 loading=lazy></a></figure></p><p>比如这张图，Height Blending 中的高度参数会对 Height Field 再进行一次修改。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/90.png data-size=1086x818><img src=/post/53/90.png srcset="/post/53/90_hue2b5061f3d098b5c38fe8743259a6962_553554_480x0_resize_box_3.png 480w, /post/53/90_hue2b5061f3d098b5c38fe8743259a6962_553554_1024x0_resize_box_3.png 1024w" width=1086 height=818 loading=lazy></a></figure></p><p>在使用 Height Blending 的情况下，搜索交点的这个过程会使用混合的结果来替代原本需要采样的高度，这时候使用顶点色来保存 Weight 会出现 Artifacts，想要得到正确的结果需要使用纹理来保存 Weight，这个应该大部分游戏都是这么做的。</p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/91.png data-size=1086x813><img src=/post/53/91.png srcset="/post/53/91_hu5a8449c9d7c6240304ceb5630c21013e_309658_480x0_resize_box_3.png 480w, /post/53/91_hu5a8449c9d7c6240304ceb5630c21013e_309658_1024x0_resize_box_3.png 1024w" width=1086 height=813 loading=lazy></a></figure></p><p>示意图。</p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/92.png data-size=1087x818><img src=/post/53/92.png srcset="/post/53/92_hu9dd19ae9c61bdd0fba58960896d7a662_524735_480x0_resize_box_3.png 480w, /post/53/92_hu9dd19ae9c61bdd0fba58960896d7a662_524735_1024x0_resize_box_3.png 1024w" width=1087 height=818 loading=lazy></a></figure></p><p>依靠距离的预处理数据，比如 DF、CSM，都不能在没有预计算的情况下跟 Blend Weights 搭配使用。依靠深度的预处理数据可以跟 Weights 配合使用。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/93.png data-size=1082x812><img src=/post/53/93.png srcset="/post/53/93_hu993174a32b59833d77413841add3425e_533690_480x0_resize_box_3.png 480w, /post/53/93_hu993174a32b59833d77413841add3425e_533690_1024x0_resize_box_3.png 1024w" width=1082 height=812 loading=lazy></a></figure></p><p>整了个 CQDM 来跟 HB 配合。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/94.png data-size=1087x822><img src=/post/53/94.png srcset="/post/53/94_huce136c9ae082075d18c2f9fb84a48ff6_542094_480x0_resize_box_3.png 480w, /post/53/94_huce136c9ae082075d18c2f9fb84a48ff6_542094_1024x0_resize_box_3.png 1024w" width=1087 height=822 loading=lazy></a></figure></p><p>QDM 和 HB 搭配使用的一些好处。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/95.png data-size=1082x813><img src=/post/53/95.png srcset="/post/53/95_hub6b7766f20b4f1fa86e8b3212c70df2a_317927_480x0_resize_box_3.png 480w, /post/53/95_hub6b7766f20b4f1fa86e8b3212c70df2a_317927_1024x0_resize_box_3.png 1024w" width=1082 height=813 loading=lazy></a></figure></p><p>展示。</p><p><figure style=flex-grow:132;flex-basis:317px><a href=/post/53/96.png data-size=1083x819><img src=/post/53/96.png srcset="/post/53/96_hu79bf489f30b5df009d67c6fcfcd0c2b4_496666_480x0_resize_box_3.png 480w, /post/53/96_hu79bf489f30b5df009d67c6fcfcd0c2b4_496666_1024x0_resize_box_3.png 1024w" width=1083 height=819 loading=lazy></a></figure></p><p>性能测试。</p><p><figure style=flex-grow:133;flex-basis:319px><a href=/post/53/97.png data-size=1083x813><img src=/post/53/97.png srcset="/post/53/97_hu320820d55172591b97523293887bbe63_1849518_480x0_resize_box_3.png 480w, /post/53/97_hu320820d55172591b97523293887bbe63_1849518_1024x0_resize_box_3.png 1024w" width=1083 height=813 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:319px><a href=/post/53/98.png data-size=1082x814><img src=/post/53/98.png srcset="/post/53/98_hufa3a1727ad403462de709bb8409a8844_1857106_480x0_resize_box_3.png 480w, /post/53/98_hufa3a1727ad403462de709bb8409a8844_1857106_1024x0_resize_box_3.png 1024w" width=1082 height=814 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/99.png data-size=1086x814><img src=/post/53/99.png srcset="/post/53/99_hu379a68e0d535d7e365cc8f792c63d7d9_1859986_480x0_resize_box_3.png 480w, /post/53/99_hu379a68e0d535d7e365cc8f792c63d7d9_1859986_1024x0_resize_box_3.png 1024w" width=1086 height=814 loading=lazy></a></figure></p><p>效果对比。</p><p><figure style=flex-grow:132;flex-basis:319px><a href=/post/53/100.png data-size=1085x816><img src=/post/53/100.png srcset="/post/53/100_hudff6acdb7d1ac7d64d452da45fe70767_504329_480x0_resize_box_3.png 480w, /post/53/100_hudff6acdb7d1ac7d64d452da45fe70767_504329_1024x0_resize_box_3.png 1024w" width=1085 height=816 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/101.png data-size=1084x816><img src=/post/53/101.png srcset="/post/53/101_hu7c0fc5fbb7924ee1349397ca40124005_531556_480x0_resize_box_3.png 480w, /post/53/101_hu7c0fc5fbb7924ee1349397ca40124005_531556_1024x0_resize_box_3.png 1024w" width=1084 height=816 loading=lazy></a></figure></p><p><figure style=flex-grow:133;flex-basis:320px><a href=/post/53/102.png data-size=1085x813><img src=/post/53/102.png srcset="/post/53/102_hu59aac3cbda1e58e745c95f2ba4c5025a_521425_480x0_resize_box_3.png 480w, /post/53/102_hu59aac3cbda1e58e745c95f2ba4c5025a_521425_1024x0_resize_box_3.png 1024w" width=1085 height=813 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/103.png data-size=1085x817><img src=/post/53/103.png srcset="/post/53/103_hub471526ebc872c58527f15b17f5549cb_499845_480x0_resize_box_3.png 480w, /post/53/103_hub471526ebc872c58527f15b17f5549cb_499845_1024x0_resize_box_3.png 1024w" width=1085 height=817 loading=lazy></a></figure></p><p><figure style=flex-grow:132;flex-basis:318px><a href=/post/53/104.png data-size=1083x815><img src=/post/53/104.png srcset="/post/53/104_hu39af4a82057583e67eec6c26f601ed75_1924534_480x0_resize_box_3.png 480w, /post/53/104_hu39af4a82057583e67eec6c26f601ed75_1924534_1024x0_resize_box_3.png 1024w" width=1083 height=815 loading=lazy></a></figure></p><p>一些总结，还有一张效果图 &mldr;&mldr;</p><hr><p>主要有价值的内容在于 Self-Shadowing 那部分，不过这部分是 POM 论文里就已经提出来的东西，只是 QDM 的 Tracing 相较于 POM 的 Tracing 对于小于 Step 的 Surface 更友好，POM 的 Self-Shadowing 可能对于这种的就直接跳过了。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/gdc/>GDC</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article><a href=/post/57/><div class=article-details><h2 class=article-title>GDC 笔记 - Simulating Tropical Weather in FARCRY6</h2></div></a></article><article><a href=/post/56/><div class=article-details><h2 class=article-title>GDC 笔记 - FidelityFX Super Resolution 2.0</h2></div></a></article><article><a href=/post/51/><div class=article-details><h2 class=article-title>GDC 笔记 - 'Ghost Recon Wildlands': Terrain Tools and Technology</h2></div></a></article><article><a href=/post/52/><div class=article-details><h2 class=article-title>GDC 笔记 - Terrain Rendering in 'Far Cry 5'</h2></div></a></article><article><a href=/post/55/><div class=article-details><h2 class=article-title>CryEngine5 Shader 调试</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=FlyAndNotDown/KindemBlog issue-term=title crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;setUtterancesTheme(document.body.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2017 -
2023 Kindem的博客</section><section class=powerby>©2017-2021 Copyright kindem.xyz / 湘ICP备17018771号-1<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.3.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>